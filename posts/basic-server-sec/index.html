<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:17.5px}</style><title>기본 서버 보안 설정</title><meta name=description content="SSH 기본 보안 설정"><meta name=keywords content="blog,gokarna,devops,security,server,linux"><meta property="og:url" content="https://junmanbo.github.io/posts/basic-server-sec/"><meta property="og:type" content="website"><meta property="og:title" content="기본 서버 보안 설정"><meta property="og:description" content="SSH 기본 보안 설정"><meta property="og:image" content="https://junmanbo.github.io/images/jun_avatar.jpg"><meta property="og:image:secure_url" content="https://junmanbo.github.io/images/jun_avatar.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="기본 서버 보안 설정"><meta name=twitter:description content="SSH 기본 보안 설정"><meta property="twitter:domain" content="https://junmanbo.github.io/posts/basic-server-sec/"><meta property="twitter:url" content="https://junmanbo.github.io/posts/basic-server-sec/"><meta name=twitter:image content="https://junmanbo.github.io/images/jun_avatar.jpg"><link rel=canonical href=https://junmanbo.github.io/posts/basic-server-sec/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.cefb5c919f4ebc418ee0e029999287fe65e11ce055c339659760dca723cb575b.js integrity="sha256-zvtckZ9OvEGO4OApmZKH/mXhHOBVwzlll2DcpyPLV1s="></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css integrity=sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js integrity=sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://junmanbo.github.io><img src=/images/jun_avatar.jpg alt="Kim Byeong Jun"></a></div><div class=nav-title><a class=nav-brand href=https://junmanbo.github.io>Jun's Blog</a></div><div class=nav-links><div class=nav-link><a href=https://junmanbo.github.io/ aria-label><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://junmanbo.github.io/posts/ aria-label><span data-feather=book></span> Posts</a></div><div class=nav-link><a href=https://junmanbo.github.io/projects/ aria-label><span data-feather=code></span> Projects</a></div><div class=nav-link><a href=https://junmanbo.github.io/tags/ aria-label><span data-feather=tag></span> Tags</a></div><div class=nav-link><a href=https://github.com/junmanbo aria-label=github><span data-feather=github></span></a></div><div class=nav-link><a href=https://junmanbo.github.io/index.xml aria-label=rss><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://junmanbo.github.io/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://junmanbo.github.io/posts/><span data-feather=book></span> Posts</a></li><li class=nav-item><a href=https://junmanbo.github.io/projects/><span data-feather=code></span> Projects</a></li><li class=nav-item><a href=https://junmanbo.github.io/tags/><span data-feather=tag></span> Tags</a></li><li class=nav-item><a href=https://github.com/junmanbo><span data-feather=github></span></a></li><li class=nav-item><a href=https://junmanbo.github.io/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>기본 서버 보안 설정</h1><small role=doc-subtitle>SSH 기본 보안 설정</small><p class=post-date>November 21, 2023</p><ul class=post-tags><li class=post-tag><a href=https://junmanbo.github.io/tags/security>security</a></li><li class=post-tag><a href=https://junmanbo.github.io/tags/server>server</a></li><li class=post-tag><a href=https://junmanbo.github.io/tags/linux>linux</a></li></ul></div><div class=post-content><p>서비스를 하다 보니 내 서버를 누가 털어가지 않을까 항상 걱정된다.<br>그래서 기초적인 보안 설정으로 서버에 접속하는걸 막아보고자 한다.</p><h2 id=접속-log-확인>접속 log 확인</h2><p>우선 누가 실제로 접속을 시도했는지 확인해 본다.</p><ul><li>SSH 로그 확인<ul><li><code>/var/log/auth.log</code> 에서 서버에 접속한 기록들을 볼 수 있다.</li></ul></li><li>접속시도한 내용 확인<ul><li><code>grep sshd.*Did /var/log/auth.log</code> | less</li></ul></li><li>접속시도 했으나 실패한 내용 확인<ul><li><code>grep sshd.Failed /var/log/auth.log</code> | less</li></ul></li></ul><p>그런데 이미 누가 접속을 성공해서 내 서버를 마음대로 쓰고 있을 수 있기 때문에 실패한 걸로만 보고 방심하면 안 된다.<br>실제로 내 AWS EC2 서버에 내 IP외의 수 많은 IP들이 찍혀 있어서 위치를 알아봤더니 미국, 유럽, 이란 등 다양하게 찍혀 있었다.</p><h2 id=외부에서-조치>외부에서 조치</h2><h3 id=ssh-key-이용>SSH Key 이용</h3><p>비밀번호 보다는 ssh key를 이용하는게 좋다.<br><code>/etc/ssh/sshd_config</code> 에서 <code>password_authentication</code> 을<code>no</code> 로 바꾼다. 비밀번호로 접근하는 걸 아예 막아버린다.<br>key는 보통 <code>.ssh</code> directory 안에 두고 directory 권한은 700 key 권한은 400으로 설정하여 아무나 사용하지 못하도록 한다.</p><h3 id=보안-그룹-설정>보안 그룹 설정</h3><p>AWS, Azure, GCP 와 같은 클라우드 서비스를 사용한다면 인바운드를 내 IP만 허용한다. 집에서 서버를 돌린다면 공유기의 네트워크 규칙을 바꾸거나 포트포워딩 설정시 IP를 제한한다.<br>하지만 허용된 IP에서만 접속할 수 있기 때문에 접속할 수 있는 장소가 한정적이게 된다. 작업은 집에서도 카페에서도 할 수 있기 때문에 IP가 매번 바뀐다. 그래서 VPN을 사용해서 해당 IP를 등록해 놓고 서버에 접속할 때는 VPN을 통해서만 접속한다.<br>Lightsail에 WireGaurd를 돌리고 있는데 저렴하고 사용하기 편하다.</p><h2 id=내부에서-조치>내부에서 조치</h2><h3 id=포트-변경>포트 변경</h3><p>ssh 포트를 바꿔준다. ssh 포트는 기본적으로 22번이고 모두가 알기 때문에 공격 받기 쉽다. 체감상 포트만 변경해도 시도가 반 정도 줄어드는 것 같다.<br><code>/etc/ssh/sshd_config</code> 에서 바꿀 수 있다.</p><h3 id=fail2ban>fail2ban</h3><p>다음으로 fail2ban을 사용하여 몇 번 이상 접속을 시도했다가 실패한 경우 ban 시킨다. (서버를 재부팅하거나 fail2ban 서비스를 재시작하면 ban이 풀린다.)<br><code>/etc/fail2ban/jail.local</code> 파일을 생성하여 원하는대로 설정하면 된다.</p><pre tabindex=0><code>[DEFAULT]

# 차단하지 않을 IP
ignoreip=127.0.0.1/8

# 차단 시간 (단위 분)
bantime=14400

# 최대 허용 횟수
maxretry=3

# 이 시간동안 maxretry횟수만큼 실패시 차단
findtime=43200

[sshd]
enabled=true
port=22
filter=sshd
logpath=/var/log/auth.log
</code></pre><ul><li>현재 차단 상황 보기<ul><li><code>sudo fail2ban-client status sshd</code></li></ul></li><li>차단 IP 풀어주기<ul><li><code>sudo fail2ban-client set sshd unbanip 123.123.123.123</code></li></ul></li><li>서비스 실행<ul><li><code>sudo systemctl enable fail2ban</code></li><li><code>sudo systemctl start fail2ban</code></li></ul></li></ul><h3 id=방화벽-설정>방화벽 설정</h3><p>iptables로 할 수 있지만 요즘엔 ufw가 기본으로 사용되어서(최신 ubuntu의 경우) ufw를 사용해서 방화벽을 설정했다.<br>설정을 해 놓고 포트를 변경하면 다시 방화벽 설정을 바꿔줘야 하므로 미리 바꿀 포트는 바꾸고 설정하는게 편하다.</p><ul><li>ufw를 활성화 시키기 전에 허용 포트를 설정해 준다.<ul><li><code>sudo ufw allow 22/tcp</code></li><li><code>sudo ufw enable</code> 이렇게 하면 허용한 포트를 제외한 나머지는 모두 방화벽에 막힌다.</li></ul></li></ul><p>비슷하게 iptables로 더 구체적인 규칙을 만들고 설정할 수 있어서 외국IP로 추정되는 것들을(특히 중국) 미리 등록해 놓고 차단 시키는 방법을 사용할 수도 있다.</p><p>그리고 RDS나 다른 서비스를 이용하려면 EC2에서만 접속할 수 있도록 설정한 다음 ssh로 터널링을 해서 접속한다. 그러면 다른 서비스에도 접속하기 어렵지 않을까?<br>이 부분은 더 공부해서 정리해 봐야 겠다.</p></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg><script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><ul><li><a href=#접속-log-확인>접속 log 확인</a></li><li><a href=#외부에서-조치>외부에서 조치</a><ul><li><a href=#ssh-key-이용>SSH Key 이용</a></li><li><a href=#보안-그룹-설정>보안 그룹 설정</a></li></ul></li><li><a href=#내부에서-조치>내부에서 조치</a><ul><li><a href=#포트-변경>포트 변경</a></li><li><a href=#fail2ban>fail2ban</a></li><li><a href=#방화벽-설정>방화벽 설정</a></li></ul></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2023 The Kim Byeong Jun</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>